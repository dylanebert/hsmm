<html>
<head>
    <title>nbcapp</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
</head>
<style>
video {
    max-width: 100%;
    height: auto;
}
.row {
    margin-top: 50px;
}
</style>
<body>
    <div class="container">
        <div class="row">
            <div class="col-sm-6"><h1>1</h1><div id="q0"></div></div>
            <div class="col-sm-6"><h1>2</h1><div id="q1"></div></div>
        </div>
        <div class="row">
            <div class="col-sm-6"><h1>3</h1><div id="q2"></div></div>
            <div class="col-sm-6"><h1>4</h1><div id="q3"></div></div>
        </div>
    </div>
</body>
<script>
window.$ = window.jQuery = require('jquery')
require('popper.js')
require('bootstrap')
const ipc = require('electron').ipcRenderer
var qidx;
var timeoutid;

function getEval() {
    playVideos = false;
    var i;
    for(i = 0; i < 4; i++) {
        $('#q' + i).html('')
    }
    while(timeoutid--) {
        window.clearTimeout(timeoutid)
    }
    get()
}

function get() {
    $.get('http://localhost:5000/get_eval', function(res) {
        playVideos = true
        if(res == 'done') {
            console.log('done')
            $('.col-sm-6').html(``)
            return;
        }
        var data = $.parseJSON(res)
        var label, questions, i, oddmanout, startStep, endStep, session, qlabel;
        [qidx, [label, questions]] = data
        console.log(label)
        for(i = 0; i < 4; i++) {
            [oddmanout, session, startTimestamp, endTimestamp, startStep, endStep, qlabel] = questions[i]
            console.log(i + ' ' + oddmanout)
            $('#q' + i).html(`
                <p>` + startStep + ` - ` + endStep + `</p>
                <video width="960" height="540" id="vid` + i + `" controls>
                    <source width="960" height="540" src="https://plunarlabcit.services.brown.edu/videos/` + session + `.mp4" type="video/mp4">
                </video>
            `)
            loopVideoClip('vid' + i, startTimestamp, endTimestamp)
        }
    })
}

function loopVideoClip(id, start, end) {
    var vid = document.getElementById(id)
    vid.pause()
    vid.currentTime = start
    var playPromise = vid.play()
    if(playPromise !== undefined) {
        playPromise.then(_ => {
            var looptime = (end - start) * 1000
            timeoutid = window.setTimeout(function() {
                loopVideoClip(id, start, end)
            }, looptime);
        }).catch(err => {

        })
    }

}

$('body').keypress(function(e) {
    var answer = -2;
    if(e.which == 49) {
        answer = 0;
    } else if(e.which == 50) {
        answer = 1;
    } else if(e.which == 51) {
        answer = 2;
    } else if(e.which == 52) {
        answer = 3;
    } else if(e.which == 48) {
        answer = -1;
    }
    if(answer > -2) {
        $.get('http://localhost:5000/write_answer?qidx=' + qidx + '&answer=' + answer, function(res) {
            console.log(res)
            getEval()
        })
    }

    if(e.which == 114) {
        getEval()
    }
})

ipc.on('loadConfig', (e, fpath) => {
    $.get('http://localhost:5000/load_config?fpath=' + fpath, function(res) {
        if(res == 'success') {
            getEval()
        }
    })
})
</script>
</html>
